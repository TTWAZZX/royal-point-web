<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Royal Point — Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    /* ===== Theme เดิมของคุณ (เก็บไว้) ===== */
    :root{
      --c-bg:#f5f7fb; --c-card:#ffffff; --c-soft:#eef3fb;
      --c-text:#1f2937; --c-mute:#6b7280; --c-ac:#0ea5e9;
      --c-border:#dbe4f3; --c-chip:#f1f5f9;
    }
    body{background:linear-gradient(180deg,#eef2f7,#f8fafc); color:var(--c-text); font-family:'Kanit',sans-serif; min-height:100vh; padding-bottom:80px;}

    /* Style สำหรับ Tab ใหม่ (Stock Manager) */
    .adm-card {
      background: #fff; border-radius: 16px; padding: 12px;
      margin-bottom: 12px; border: 1px solid #e2e8f0;
      display: flex; gap: 12px; align-items: center;
      transition: transform 0.2s; position: relative;
    }
    .adm-card.inactive { opacity: 0.6; background: #f1f5f9; border-style: dashed; }
    
    .adm-img {
      width: 64px; height: 64px; border-radius: 10px;
      object-fit: cover; background: #eee; flex-shrink: 0;
    }

    .adm-content { flex-grow: 1; min-width: 0; }
    .adm-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 2px; color: #1e293b; }
    .adm-cost { font-size: 0.85rem; color: #64748b; font-weight: 500; }

    /* ปุ่มเพิ่มลดสต็อก */
    .stock-control {
      display: flex; align-items: center; gap: 4px;
      background: #f1f5f9; padding: 3px; border-radius: 8px;
      margin-top: 6px; width: fit-content;
    }
    .btn-qty {
      width: 26px; height: 26px; border: none; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; cursor: pointer; transition: 0.1s;
    }
    .btn-dec { background: #fee2e2; color: #ef4444; }
    .btn-inc { background: #dcfce7; color: #16a34a; }
    
    .stock-num { min-width: 24px; text-align: center; font-weight: 700; font-size: 0.9rem; }
    .stock-num.zero { color: #ef4444; }

    /* Actions */
    .adm-actions { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
    
    /* Nav Pills Style */
    .nav-pills .nav-link { color: var(--c-mute); font-weight:500; border-radius:12px; }
    .nav-pills .nav-link.active { background-color: var(--c-ac); color:#fff; box-shadow:0 4px 12px rgba(14,165,233,0.3); }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top px-3">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <a class="navbar-brand fw-bold text-primary me-2" href="#">
          <i class="fa-solid fa-shield-halved me-2"></i>
          <span id="adminName">Admin Console</span>
        </a>
        <small class="text-muted border-start ps-2" style="font-size: 0.75rem;" id="adminUid">Connecting...</small>
      </div>

      <a href="/" class="btn btn-sm btn-outline-secondary rounded-pill">
        <i class="fa-solid fa-arrow-left me-1"></i>กลับหน้าหลัก
      </a>
    </div>
  </nav>

  <div class="container py-4">
    
    <ul class="nav nav-pills mb-4 overflow-auto flex-nowrap pb-2" id="adminTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="tab-stock-btn" data-bs-toggle="pill" data-bs-target="#tab-stock" type="button">
          <i class="fa-solid fa-boxes-stacked me-1"></i> ของรางวัล
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="tab-coupons-btn" data-bs-toggle="pill" data-bs-target="#pills-coupons" type="button">
          <i class="fa-solid fa-ticket me-1"></i> คูปอง
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="tab-users-btn" data-bs-toggle="pill" data-bs-target="#pills-users" type="button">
          <i class="fa-solid fa-users me-1"></i> สมาชิก
        </button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
      
      <div class="tab-pane fade show active" id="tab-stock" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="fw-bold m-0 text-dark">จัดการสต็อก</h5>
          <button class="btn btn-primary btn-sm rounded-pill shadow-sm" onclick="openEditModal()">
            <i class="fa-solid fa-plus"></i> เพิ่มสินค้า
          </button>
        </div>

        <div id="rewardListArea">
          <div class="text-center py-5 text-muted">
            <div class="spinner-border text-primary spinner-border-sm mb-2"></div>
            <div>กำลังโหลดข้อมูล...</div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pills-coupons" role="tabpanel">
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body p-3">
            <div class="row g-2 align-items-end">
              <div class="col-6 col-md-3">
                <label class="form-label small text-muted">แต้ม/ใบ</label>
                <input type="number" id="genPoints" class="form-control" value="100">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label small text-muted">จำนวนใบ</label>
                <input type="number" id="genCount" class="form-control" value="10">
              </div>
              <div class="col-12 col-md-3">
                <button id="btnGen" class="btn btn-primary w-100 fw-bold">
                  <i class="fa-solid fa-magic me-1"></i> สร้างคูปอง
                </button>
              </div>
              <div class="col-12 col-md-3">
                <button id="btnReload" class="btn btn-light w-100 border">
                  <i class="fa-solid fa-rotate me-1"></i> รีโหลด
                </button>
              </div>
            </div>
          </div>
        </div>

        <ul class="nav nav-underline mb-3 small" id="couponTabs">
          <li class="nav-item">
            <a class="nav-link active" href="#" data-filter="all">ทั้งหมด</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-filter="unused">ยังไม่ใช้</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-filter="used">ใช้แล้ว</a>
          </li>
        </ul>

        <div id="couponList" class="vstack gap-2"></div>
      </div>

      <div class="tab-pane fade" id="pills-users" role="tabpanel">
        <div class="alert alert-info border-0 shadow-sm d-flex align-items-center">
          <i class="fa-solid fa-circle-info me-2"></i>
          <div>ตารางสมาชิกและประวัติ (โหลดผ่าน admin.page.js)</div>
        </div>
        <div class="card border-0 shadow-sm">
          <div class="card-body p-3">
             <div class="input-group mb-3">
                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0" placeholder="ค้นหาชื่อ, เบอร์, UID...">
                <button class="btn btn-light border" id="btnRefreshPage"><i class="fa-solid fa-rotate"></i></button>
             </div>
             <div class="table-responsive">
               <table class="table table-hover align-middle mb-0">
                 <thead class="bg-light">
                   <tr>
                     <th class="ps-3">UID</th>
                     <th>ชื่อ</th>
                     <th>แต้ม</th>
                     <th>จัดการ</th>
                   </tr>
                 </thead>
                 <tbody id="adminTableBody">
                   </tbody>
               </table>
             </div>
             <div class="d-flex justify-content-between align-items-center mt-3">
               <button id="btnPrev" class="btn btn-sm btn-outline-secondary" disabled>ก่อนหน้า</button>
               <span id="pageInfo" class="small text-muted">หน้า 1</span>
               <button id="btnNext" class="btn btn-sm btn-outline-secondary" disabled>ถัดไป</button>
             </div>
          </div>
        </div>
      </div>

    </div><div class="modal fade" id="qrModal" tabindex="-1">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content text-center p-3 rounded-4">
          <h6 class="fw-bold mb-3">QR Code คูปอง</h6>
          <div id="qrCanvas" class="bg-light mx-auto mb-3" style="width:200px;height:200px;display:flex;align-items:center;justify-content:center;">
            </div>
          <div class="d-grid gap-2">
            <button class="btn btn-primary" id="btnDownloadQR">บันทึกรูป</button>
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ปิด</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">แก้ไขสินค้า</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" id="editId">
              <div class="mb-3">
                <label class="small text-muted">ชื่อของรางวัล</label>
                <input type="text" class="form-control" id="editName" required>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="small text-muted">ราคา (Points)</label>
                  <input type="number" class="form-control" id="editCost" required>
                </div>
                <div class="col-6">
                  <label class="small text-muted">ลำดับ (Sort)</label>
                  <input type="number" class="form-control" id="editSort" placeholder="999">
                </div>
              </div>
              <div class="mb-3">
                <label class="small text-muted">URL รูปภาพ</label>
                <input type="text" class="form-control" id="editImg">
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary rounded-pill fw-bold">บันทึก</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="actionModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow"><div class="modal-header"><h6 class="modal-title fw-bold">จัดการสมาชิก</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3 text-center"><div class="fw-bold h5 mb-0" id="actionUserName">-</div><div class="small text-muted" id="actionUserUID">-</div></div><div class="mb-3"><label class="form-label small">เลือกรายการ</label><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="adjustType" id="radioAdd" value="add" checked><label class="btn btn-outline-success" for="radioAdd">เพิ่มแต้ม</label><input type="radio" class="btn-check" name="adjustType" id="radioDel" value="del"><label class="btn btn-outline-danger" for="radioDel">ลบแต้ม</label><input type="radio" class="btn-check" name="adjustType" id="radioReset" value="reset"><label class="btn btn-outline-warning" for="radioReset">รีเซ็ต 0</label></div></div><div class="mb-3"><label class="form-label small">จำนวนแต้ม</label><input type="number" id="adjustAmount" class="form-control" placeholder="0"></div><div class="mb-3"><label class="form-label small">เหตุผล / หมายเหตุ</label><input type="text" id="adjustNote" class="form-control" placeholder="เช่น กิจกรรมพิเศษ..."></div><div class="d-grid"><button class="btn btn-primary" id="btnConfirmAdjust">ยืนยัน</button></div></div></div></div></div>

    <div class="modal fade" id="historyModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow"><div class="modal-header"><h6 class="modal-title fw-bold">ประวัติคะแนน</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="table-responsive" style="max-height:60vh"><table class="table table-sm table-hover mb-0"><thead class="table-light sticky-top"><tr><th>เวลา</th><th>แต้ม</th><th>ประเภท</th><th>รายละเอียด</th></tr></thead><tbody id="historyTableBody"></tbody></table></div></div></div></div></div>

  </div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="loader.js"></script>

  <script src="admin.js"></script>
  <script src="admin.page.js"></script>

  <script>
    /* =========================================
       NEW: STOCK MANAGER LOGIC
       ========================================= */
    const getMyUid = () => {
        const params = new URLSearchParams(window.location.search);
        return params.get('uid') || sessionStorage.getItem('uid') || localStorage.getItem('uid');
    };

    let ALL_REWARDS_DATA = [];

    async function loadRewardsData() {
        const listArea = document.getElementById('rewardListArea');
        if(!listArea) return;
        try {
            const res = await fetch('/api/rewards?include=1');
            const json = await res.json();
            ALL_REWARDS_DATA = (json.items || []).sort((a,b) => (a.sort_index || 999) - (b.sort_index || 999));
            renderRewardList(ALL_REWARDS_DATA);
        } catch (err) {
            console.error(err);
            listArea.innerHTML = `<div class="text-center text-danger mt-4">โหลดข้อมูลผิดพลาด</div>`;
        }
    }

    function renderRewardList(list) {
        const listArea = document.getElementById('rewardListArea');
        if (list.length === 0) { listArea.innerHTML = `<div class="text-center text-muted mt-5">ไม่มีข้อมูลของรางวัล</div>`; return; }
        listArea.innerHTML = list.map(r => {
            const isActive = r.active;
            const stock = parseInt(r.stock || 0);
            const isZero = stock <= 0;
            return `
            <div class="adm-card ${!isActive ? 'inactive' : ''}" id="card-${r.id}">
                <img src="${r.img || 'https://placehold.co/100'}" class="adm-img" onclick="openEditModal('${r.id}')">
                <div class="adm-content">
                    <div class="adm-title text-truncate">${r.name}</div>
                    <div class="adm-cost">${r.cost} Points</div>
                    <div class="stock-control">
                        <button class="btn-qty btn-dec" onclick="updateStock('${r.id}', -1)"><i class="fa-solid fa-minus"></i></button>
                        <div class="stock-num ${isZero ? 'zero' : ''}" id="stock-val-${r.id}">${stock}</div>
                        <button class="btn-qty btn-inc" onclick="updateStock('${r.id}', 1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div class="adm-actions">
                    <div class="form-check form-switch m-0"><input class="form-check-input" type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleActive('${r.id}', this.checked)"></div>
                    <button class="btn btn-sm text-secondary" onclick="openEditModal('${r.id}')"><i class="fa-solid fa-pen"></i></button>
                </div>
            </div>`;
        }).join('');
    }

    async function updateStock(id, delta) {
        const item = ALL_REWARDS_DATA.find(x => x.id == id);
        if (!item) return;
        const newStock = Math.max(0, parseInt(item.stock || 0) + delta);
        if (newStock === item.stock) return;
        document.getElementById(`stock-val-${id}`).textContent = newStock;
        item.stock = newStock;
        const stockNum = document.getElementById(`stock-val-${id}`);
        if(newStock <= 0) stockNum.classList.add('zero'); else stockNum.classList.remove('zero');

        try {
            await Loading.apiFetch('/api/admin-actions', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reward_update', adminUid: getMyUid(), rewardId: id, rewardData: { stock: newStock } })
            }, { scope: 'inline' });
        } catch (err) { console.error(err); }
    }

    async function toggleActive(id, status) {
        try {
            await Loading.apiFetch('/api/admin-actions', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reward_update', adminUid: getMyUid(), rewardId: id, rewardData: { active: status } })
            }, { scope: 'inline' });
            const card = document.getElementById(`card-${id}`);
            if(status) card.classList.remove('inactive'); else card.classList.add('inactive');
        } catch (err) { console.error(err); }
    }

    const editModalEl = new bootstrap.Modal('#editModal');
    window.openEditModal = (id) => {
        if (!id) { Swal.fire('Info', 'ฟีเจอร์เพิ่มสินค้าใหม่ กำลังพัฒนา', 'info'); return; }
        const item = ALL_REWARDS_DATA.find(x => x.id == id);
        document.getElementById('editId').value = item.id;
        document.getElementById('editName').value = item.name;
        document.getElementById('editCost').value = item.cost;
        document.getElementById('editSort').value = item.sort_index || 999;
        document.getElementById('editImg').value = item.img || '';
        editModalEl.show();
    }
    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const name = document.getElementById('editName').value;
        const cost = parseInt(document.getElementById('editCost').value);
        const sort = parseInt(document.getElementById('editSort').value);
        const img = document.getElementById('editImg').value;
        editModalEl.hide();
        try {
            await Loading.apiFetch('/api/admin-actions', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reward_update', adminUid: getMyUid(), rewardId: id, rewardData: { name: name, cost: cost, sort_index: sort, img_url: img } })
            });
            Swal.fire('Success', 'บันทึกข้อมูลแล้ว', 'success');
            loadRewardsData();
        } catch (err) { Swal.fire('Error', err.message, 'error'); }
    });

    document.addEventListener('DOMContentLoaded', loadRewardsData);
  </script>
</body>
</html>