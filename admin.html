<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Admin Console</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --c-bg:#f0f2f5; --c-primary:#0ea5e9; --c-text:#1e293b;
    }
    body { background: var(--c-bg); color: var(--c-text); font-family: 'Kanit', sans-serif; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
    
    /* === Mobile Navbar === */
    .mobile-nav {
      background: #fff; padding: 12px 16px; 
      border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1020;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .nav-profile { display: flex; align-items: center; gap: 10px; }
    .nav-avatar { 
      width: 38px; height: 38px; background: #e0f2fe; color: #0284c7; 
      border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    }
    
    /* === Tabs (Scrollable) === */
    .nav-pills { 
      flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; 
      padding-bottom: 5px; gap: 8px; -webkit-overflow-scrolling: touch; 
    }
    .nav-pills::-webkit-scrollbar { display: none; }
    .nav-pills .nav-link { 
      border-radius: 20px; font-weight: 500; color: #64748b; 
      background: #fff; border: 1px solid #e2e8f0; padding: 8px 16px;
    }
    .nav-pills .nav-link.active { 
      background: var(--c-primary); color: #fff; border-color: var(--c-primary); 
      box-shadow: 0 4px 6px rgba(14, 165, 233, 0.2);
    }

    /* === Cards (Mobile Style) === */
    .m-card {
      background: #fff; border-radius: 16px; padding: 14px; margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.02); border: 1px solid #f1f5f9;
      position: relative;
    }
    
    /* === Stock Manager Style === */
    .stock-row { display: flex; gap: 12px; align-items: center; }
    .stock-img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; background: #f8fafc; }
    .stock-ctrl { 
      display: flex; align-items: center; gap: 8px; background: #f8fafc; 
      padding: 4px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 8px;
    }
    .btn-qty { 
      width: 32px; height: 32px; border-radius: 8px; border: none; 
      display: flex; align-items: center; justify-content: center; 
    }
    .btn-dec { background: #fee2e2; color: #ef4444; }
    .btn-inc { background: #dcfce7; color: #16a34a; }
    
    /* === Helper Classes === */
    .fs-7 { font-size: 0.85rem; }
    .btn-float {
      position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
      border-radius: 50%; background: var(--c-primary); color: #fff;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4); z-index: 1030;
      font-size: 1.2rem; border: none;
    }
  </style>
</head>
<body>

  <nav class="mobile-nav">
    <div class="nav-profile">
      <div class="nav-avatar"><i class="fa-solid fa-user-shield"></i></div>
      <div style="line-height: 1.2;">
        <div class="fw-bold text-dark" style="font-size: 1rem;" id="adminName">Admin</div>
        <div class="text-muted" style="font-size: 0.75rem;">ผู้ดูแลระบบ</div>
      </div>
    </div>
    <a href="/" class="btn btn-sm btn-light border rounded-pill px-3 fw-bold text-secondary">
      <i class="fa-solid fa-arrow-right-from-bracket"></i>
    </a>
    <span id="adminUid" class="d-none"></span>
  </nav>

  <div class="container px-3 py-3">
    
    <ul class="nav nav-pills mb-3" id="adminTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-stock">
          <i class="fa-solid fa-boxes-stacked me-1"></i> ของรางวัล
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-users">
          <i class="fa-solid fa-users me-1"></i> สมาชิก
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-coupons">
          <i class="fa-solid fa-ticket me-1"></i> คูปอง
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-history" id="tabHistoryBtn">
          <i class="fa-solid fa-clock-rotate-left me-1"></i> ประวัติ
        </button>
      </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
      
      <div class="tab-pane fade show active" id="tab-stock" role="tabpanel">
        <div id="rewardListArea">
          <div class="text-center py-5 text-muted">
            <div class="spinner-border text-primary spinner-border-sm mb-2"></div>
            <div>กำลังโหลดข้อมูล...</div>
          </div>
        </div>
        <button class="btn-float" onclick="openEditModal()">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>

      <div class="tab-pane fade" id="pills-users" role="tabpanel">
        
        <div class="m-card bg-primary text-white border-0 d-flex align-items-center justify-content-between p-3 mb-3" 
             style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">
          <div>
            <div class="fw-bold"><i class="fa-solid fa-gift me-2"></i>แจกแต้มพิเศษ</div>
            <div class="small opacity-75">ให้สมาชิกทุกคน</div>
          </div>
          <button id="btnGiveaway" class="btn btn-light text-primary fw-bold rounded-pill px-3 shadow-sm btn-sm">
            แจกเลย
          </button>
        </div>

        <div class="m-card p-2 mb-3">
          <div class="input-group">
            <span class="input-group-text bg-white border-0 ps-3"><i class="fa-solid fa-search text-muted"></i></span>
            <input type="text" id="searchInput" class="form-control border-0 bg-white shadow-none" placeholder="ค้นหาชื่อ, เบอร์..." style="font-size: 0.95rem;">
            <button class="btn btn-light rounded-circle ms-2" id="btnRefreshPage" style="width:40px; height:40px; background:#f1f5f9;">
              <i class="fa-solid fa-rotate-right text-secondary"></i>
            </button>
          </div>
        </div>

        <div id="adminTableBody" class="pb-5">
          </div>
        
        <div class="d-flex justify-content-center align-items-center gap-3 mt-3 pb-5">
           <button id="btnPrev" class="btn btn-sm btn-light border rounded-pill px-3" disabled>ก่อนหน้า</button>
           <span id="pageInfo" class="small text-muted fw-bold">1 / 1</span>
           <button id="btnNext" class="btn btn-sm btn-light border rounded-pill px-3" disabled>ถัดไป</button>
        </div>
      </div>

      <div class="tab-pane fade" id="pills-coupons" role="tabpanel">
        <div class="m-card">
          <div class="fw-bold mb-2">สร้างคูปองใหม่</div>
          <div class="row g-2">
            <div class="col-6">
              <input type="number" id="genPoints" class="form-control bg-light border-0" placeholder="แต้ม" value="100">
            </div>
            <div class="col-6">
              <input type="number" id="genCount" class="form-control bg-light border-0" placeholder="จำนวน" value="10">
            </div>
            <div class="col-12 mt-2">
              <button id="btnGen" class="btn btn-primary w-100 rounded-3 fw-bold py-2">
                <i class="fa-solid fa-magic me-1"></i> สร้างคูปอง
              </button>
            </div>
          </div>
        </div>

        <ul class="nav nav-pills mb-3" id="couponTabs" style="font-size: 0.9rem;">
          <li class="nav-item"><a class="nav-link active py-1 px-3 border-0" href="#" data-filter="all">ทั้งหมด</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-3 border-0" href="#" data-filter="unused">ยังไม่ใช้</a></li>
          <li class="nav-item"><a class="nav-link py-1 px-3 border-0" href="#" data-filter="used">ใช้แล้ว</a></li>
        </ul>

        <div id="couponList" class="pb-5"></div>
      </div>

      <div class="tab-pane fade" id="pills-history" role="tabpanel">
        <div class="m-card p-2 mb-3">
          <div class="input-group">
            <span class="input-group-text bg-white border-0 ps-3"><i class="fa-solid fa-search text-muted"></i></span>
            <input type="text" id="historySearch" class="form-control border-0 bg-white shadow-none" placeholder="ค้นหาชื่อผู้ใช้ หรือ ของรางวัล..." style="font-size: 0.95rem;" onkeyup="filterHistory()">
            <button class="btn btn-light rounded-circle ms-2" onclick="loadRedemptionHistory()" style="width:40px; height:40px; background:#f1f5f9;">
              <i class="fa-solid fa-rotate-right text-secondary"></i>
            </button>
          </div>
        </div>

        <div id="historyListArea" class="pb-5">
          <div class="text-center py-5 text-muted">
            <div class="spinner-border text-primary spinner-border-sm mb-2"></div>
            <div>กำลังโหลดข้อมูล...</div>
          </div>
        </div>
      </div>

    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0">
          <div class="modal-header border-0 pb-0">
            <h6 class="modal-title fw-bold">แก้ไขสินค้า</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <input type="hidden" id="editId">
              <div class="mb-2">
                <label class="small text-muted">ชื่อ</label>
                <input type="text" class="form-control" id="editName" required>
              </div>
              <div class="row g-2 mb-2">
                <div class="col-6">
                  <label class="small text-muted">แต้ม</label>
                  <input type="number" class="form-control" id="editCost" required>
                </div>
                <div class="col-6">
                  <label class="small text-muted">ลำดับ</label>
                  <input type="number" class="form-control" id="editSort">
                </div>
              </div>
              <div class="mb-3">
                <label class="small text-muted">รูปภาพ (URL)</label>
                <input type="text" class="form-control" id="editImg">
              </div>
              <button type="submit" class="btn btn-primary w-100 rounded-pill fw-bold">บันทึก</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="actionModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0">
          <div class="modal-body p-4">
            <div class="text-center mb-3">
              <div class="fw-bold fs-5" id="actionUserName">-</div>
              <div class="small text-muted text-truncate" id="actionUserUID" style="max-width: 200px; margin: 0 auto;">-</div>
            </div>
            
            <div class="btn-group w-100 mb-3" role="group">
              <input type="radio" class="btn-check" name="adjustType" id="radioAdd" value="add" checked>
              <label class="btn btn-outline-success" for="radioAdd">เพิ่ม</label>
              <input type="radio" class="btn-check" name="adjustType" id="radioDel" value="del">
              <label class="btn btn-outline-danger" for="radioDel">ลบ</label>
              <input type="radio" class="btn-check" name="adjustType" id="radioReset" value="reset">
              <label class="btn btn-outline-warning" for="radioReset">รีเซ็ต</label>
            </div>

            <input type="number" id="adjustAmount" class="form-control mb-2 text-center" placeholder="จำนวนแต้ม" style="font-size: 1.2rem;">
            <input type="text" id="adjustNote" class="form-control mb-3 text-center small" placeholder="เหตุผล (ถ้ามี)">
            
            <button class="btn btn-primary w-100 rounded-pill fw-bold py-2" id="btnConfirmAdjust">ยืนยัน</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 border-0" style="height: 70vh;">
          <div class="modal-header border-0 pb-0">
            <h6 class="modal-title fw-bold">ประวัติคะแนน</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body p-0 mt-2">
            <table class="table table-borderless table-striped small mb-0">
              <thead class="sticky-top bg-white border-bottom">
                <tr><th class="ps-3">เวลา</th><th>รายการ</th><th class="text-end pe-3">แต้ม</th></tr>
              </thead>
              <tbody id="historyTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="qrModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0 text-center p-4">
          <h6 class="fw-bold mb-3">QR Code คูปอง</h6>
          <div id="qrCanvas" class="bg-light rounded mx-auto mb-3 d-flex align-items-center justify-content-center" style="width:200px; height:200px;"></div>
          <button class="btn btn-light w-100 rounded-pill text-muted" data-bs-dismiss="modal">ปิดหน้าต่าง</button>
        </div>
      </div>
    </div>

  </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="loader.js"></script>
  <script src="admin.js"></script>
  <script src="admin.page.js"></script>

  <script>
    const getMyUid = () => {
        const params = new URLSearchParams(window.location.search);
        return params.get('uid') || sessionStorage.getItem('uid') || localStorage.getItem('uid');
    };

    let ALL_REWARDS_DATA = [];

    async function loadRewardsData() {
        const listArea = document.getElementById('rewardListArea');
        if(!listArea) return;
        try {
            const res = await fetch('/api/rewards?include=1');
            const json = await res.json();
            ALL_REWARDS_DATA = (json.items || []).sort((a,b) => (a.sort_index || 999) - (b.sort_index || 999));
            renderRewardList(ALL_REWARDS_DATA);
        } catch (err) {
            console.error(err);
            listArea.innerHTML = `<div class="text-center text-danger mt-4">โหลดข้อมูลผิดพลาด</div>`;
        }
    }

    function renderRewardList(list) {
        const listArea = document.getElementById('rewardListArea');
        if (list.length === 0) { listArea.innerHTML = `<div class="text-center text-muted mt-5">ไม่มีข้อมูล</div>`; return; }
        
        listArea.innerHTML = list.map(r => {
            const isActive = r.active;
            const stock = parseInt(r.stock || 0);
            const isZero = stock <= 0;
            return `
            <div class="m-card ${!isActive ? 'opacity-50' : ''}" id="card-${r.id}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                   <div class="stock-row">
                      <img src="${r.img || 'https://placehold.co/100'}" class="stock-img" onclick="openEditModal('${r.id}')">
                      <div>
                         <div class="fw-bold text-dark text-truncate" style="max-width: 140px;">${r.name}</div>
                         <div class="text-primary small fw-bold">${r.cost} pt</div>
                      </div>
                   </div>
                   <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" ${isActive ? 'checked' : ''} onchange="toggleActive('${r.id}', this.checked)">
                   </div>
                </div>
                
                <div class="d-flex align-items-center justify-content-between pt-2 border-top mt-2">
                   <div class="text-muted small" onclick="openEditModal('${r.id}')"><i class="fa-solid fa-pen me-1"></i> แก้ไข</div>
                   <div class="stock-ctrl">
                      <button class="btn-qty btn-dec" onclick="updateStock('${r.id}', -1)"><i class="fa-solid fa-minus"></i></button>
                      <div class="fw-bold px-2 ${isZero ? 'text-danger' : 'text-dark'}" style="min-width:30px; text-align:center;" id="stock-val-${r.id}">${stock}</div>
                      <button class="btn-qty btn-inc" onclick="updateStock('${r.id}', 1)"><i class="fa-solid fa-plus"></i></button>
                   </div>
                </div>
            </div>`;
        }).join('');
    }

    // Update Stock (มี Effect แจ้งเตือน)
    async function updateStock(id, delta) {
        const item = ALL_REWARDS_DATA.find(x => x.id == id);
        if (!item) return;

        const oldStock = parseInt(item.stock || 0);
        const newStock = Math.max(0, oldStock + delta);
        if (newStock === oldStock) return;

        // --- 1. Visual Feedback (Animation) ---
        const stockEl = document.getElementById(`stock-val-${id}`);
        stockEl.textContent = newStock;
        
        // เปลี่ยนสีและขยายตัวเลขชั่วคราว
        stockEl.style.transition = "all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
        stockEl.style.transform = "scale(1.3)";
        stockEl.style.color = delta > 0 ? "#16a34a" : "#dc2626"; // เขียว/แดง
        
        // คืนค่าเดิมหลังจาก 0.3 วินาที
        setTimeout(() => {
            stockEl.style.transform = "scale(1)";
            stockEl.style.color = "";
        }, 300);

        // อัปเดตข้อมูลในตัวแปร
        item.stock = newStock;
        if(newStock <= 0) stockEl.classList.add('zero'); else stockEl.classList.remove('zero');

        try {
            await Loading.apiFetch('/api/admin-actions', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'reward_update', 
                    adminUid: getMyUid(), 
                    rewardId: id, 
                    rewardData: { stock: newStock } 
                })
            }, { scope: 'inline' }); // ไม่ต้องโชว์ Loading ใหญ่

            // --- 2. Toast Notification ---
            // แจ้งเตือนเล็กๆ ด้านบน
            const Toast = Swal.mixin({
                toast: true,
                position: 'top',
                showConfirmButton: false,
                timer: 1000,
                timerProgressBar: false
            });
            
            Toast.fire({
                icon: 'success',
                title: delta > 0 ? `+${delta} ชิ้น` : `${delta} ชิ้น`
            });

        } catch (err) { 
            console.error(err);
            // ถ้า Error ให้คืนค่าเดิม
            stockEl.textContent = oldStock;
            item.stock = oldStock;
            Swal.fire('ข้อผิดพลาด', 'อัปเดตสต็อกไม่สำเร็จ', 'error');
        }
    }

    async function toggleActive(id, status) {
        try {
            await Loading.apiFetch('/api/admin-actions', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reward_update', adminUid: getMyUid(), rewardId: id, rewardData: { active: status } })
            }, { scope: 'inline' });
            const card = document.getElementById(`card-${id}`);
            if(status) card.classList.remove('opacity-50'); else card.classList.add('opacity-50');
        } catch (err) { console.error(err); }
    }

    const editModalEl = new bootstrap.Modal('#editModal');
    window.openEditModal = (id) => {
        if (!id) { document.getElementById('editForm').reset(); document.getElementById('editId').value=''; editModalEl.show(); return; }
        const item = ALL_REWARDS_DATA.find(x => x.id == id);
        document.getElementById('editId').value = item.id;
        document.getElementById('editName').value = item.name;
        document.getElementById('editCost').value = item.cost;
        document.getElementById('editSort').value = item.sort_index || 999;
        document.getElementById('editImg').value = item.img || '';
        editModalEl.show();
    }
    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const name = document.getElementById('editName').value;
        const cost = parseInt(document.getElementById('editCost').value);
        const sort = parseInt(document.getElementById('editSort').value);
        const img = document.getElementById('editImg').value;
        editModalEl.hide();
        try {
            // Check if Add or Update
            if(!id) {
               Swal.fire('Info', 'ฟีเจอร์เพิ่มสินค้าใหม่ ต้องทำ API รองรับ INSERT', 'info');
               return; 
            }
            await Loading.apiFetch('/api/admin-actions', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reward_update', adminUid: getMyUid(), rewardId: id, rewardData: { name, cost, sort_index: sort, img_url: img } })
            });
            Swal.fire('Success', 'บันทึกเรียบร้อย', 'success');
            loadRewardsData();
        } catch (err) { Swal.fire('Error', err.message, 'error'); }
    });

    document.addEventListener('DOMContentLoaded', loadRewardsData);
  </script>
</body>
</html>