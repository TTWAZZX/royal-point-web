<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äì Royal Point</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body {
      background:#f8fafc;
      font-family: 'Kanit', sans-serif;
    }

    .reward-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
      padding: 8px;
    }

    .reward-card {
      position: relative;
      border-radius: 14px;
      background: #fff;
      border: 1px solid #e2e8f0;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      overflow: hidden;
    }

    .reward-card img {
      width: 100%;
      height: 140px;
      object-fit: contain;
      background: #fff;
      padding: 8px;
    }

    .reward-name {
      font-weight: 600;
      font-size: 0.95rem;
      padding: 6px 10px 0;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .reward-cost {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f0fdfa;
      color: #047857;
      padding: 2px 8px;
      font-weight: 700;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid #94d6c3;
      z-index: 10;
    }

    .reward-stock {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.65);
      padding: 2px 8px;
      font-size: 0.7rem;
      border-radius: 6px;
      color: #fff;
      font-weight: 600;
      z-index: 10;
    }

    .reward-footer {
      padding: 6px 10px 10px;
    }

    .reward-card.soldout {
      opacity: 0.55;
    }

    .reward-card.soldout::after {
      content: "‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß";
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: 900;
      color: #b91c1c;
      font-size: 1.2rem;
      z-index: 20;
    }
  </style>
</head>

<body>

<div class="container py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold text-success m-0">üéÅ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö -->
    <a href="/" class="text-success fs-4">
      <i class="fa-solid fa-arrow-left-long"></i>
    </a>
  </div>

  <!-- Grid -->
  <div id="rewardGrid" class="reward-grid"></div>

</div>

<!-- Redeem Modal -->
<div class="modal fade" id="redeemModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-body text-center p-4">
        <h5 class="fw-bold mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h5>
        <p id="redeemText" class="text-muted mb-4"></p>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary w-50" data-bs-dismiss="modal">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button class="btn btn-success w-50" id="confirmRedeemBtn">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast align-items-center text-bg-success border-0">
    <div class="d-flex">
      <div class="toast-body">
        üéâ ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      </div>
      <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
/* ===============================
   LOAD REWARDS
================================ */
async function loadAllRewards() {
  const res = await fetch('/api/rewards?include=1', { cache:'no-store' });
  const j = await res.json();

  const list = (j.items || []).map(x => ({
    id: x.id,
    name: x.name,
    cost: Number(x.cost || 0),
    img: x.img,
    stock: Number(x.stock ?? 0),
    stock_max: Number(x.stock_max ?? 0),
    sort_index: Number(x.sort_index ?? 999),
  }));

  // ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ stock ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
  list.sort((a,b)=>{
    if (a.stock <= 0 && b.stock > 0) return 1;
    if (b.stock <= 0 && a.stock > 0) return -1;
    return a.sort_index - b.sort_index;
  });

  renderGrid(list);
}

/* ===============================
   RENDER
================================ */
function renderGrid(list) {
  const wrap = document.getElementById('rewardGrid');

  wrap.innerHTML = list.map(r => `
    <div class="reward-card ${r.stock <= 0 ? 'soldout' : ''}">
      
      <img src="${r.img}" alt="${r.name}">

      <div class="reward-cost">${r.cost} pt</div>

      <div class="reward-stock">
        ${r.stock <= 0 ? '‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß' : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${r.stock}/${r.stock_max}`}
      </div>

      <div class="reward-name">${r.name}</div>

      <div class="reward-footer">
        <button
          class="btn btn-sm btn-success w-100"
          onclick="redeemReward('${r.id}', ${r.cost})"
          ${r.stock <= 0 ? 'disabled' : ''}>
          ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
        </button>
      </div>
    </div>
  `).join('');
}

/* ===============================
   REDEEM (API ‡∏à‡∏£‡∏¥‡∏á)
================================ */
async function redeemReward(rewardId, cost) {
  // üîí ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  if (window.__redeeming) return;
  window.__redeeming = true;

  try {
    const uid = localStorage.getItem('uid'); // ‡∏õ‡∏£‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ auth ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô

    if (!uid) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á');
      return;
    }

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${cost} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ?`)) return;

    const res = await fetch('/api/spend', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        uid,
        rewardId,
        cost
      })
    });

    const j = await res.json();

    if (!res.ok) {
      alert(j.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏Å‡πÑ‡∏î‡πâ');
      return;
    }

    alert('üéâ ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    loadAllRewards(); // refresh stock realtime

  } catch (err) {
    console.error(err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');

  } finally {
    // üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏°‡∏≠
    window.__redeeming = false;
  }
}

loadAllRewards();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
