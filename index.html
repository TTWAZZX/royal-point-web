<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Royal Point</title>

  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='64' fill='%2322c55e'/%3E%3Ctext x='50%25' y='57%25' text-anchor='middle' dominant-baseline='middle' font-size='80' fill='white'%3E‚òÖ%3C/text%3E%3C/svg%3E">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+Thai:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>

  <!-- App Styles -->
  <link rel="stylesheet" href="/style.css"/>

  <link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>
</head>
<body>

<!-- Top progress bar -->
<div id="topProgress" class="top-progress" aria-hidden="true">
  <div class="top-progress__bar" id="topProgressBar"></div>
</div>

<!-- Offline banner -->
<div id="offlineBanner" class="offline-banner d-none" role="status" aria-live="polite">
  <i class="fa-solid fa-cloud-slash"></i> ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä
</div>

<main class="rp-container container py-3">
  <!-- ===== Profile Card ===== -->
  <section class="rp-glass rp-card rp-profile-card p-3 p-sm-4 mb-3 hover-lift">
    <span id="lastUpdated" class="hidden text-xs text-muted"></span>

    <div class="rp-top-right">
      <button id="refreshBtn" class="btn btn-outline-secondary btn-icon mini" aria-label="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä"
              data-bs-toggle="tooltip" data-bs-placement="left" title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‚Äî">
        <i class="fa-solid fa-rotate"></i>
      </button>
    </div>

    <div class="rp-left">
      <div class="rp-left-col">
        <div class="rp-avatar-wrap rp-tier-silver" id="rpAvatar" aria-label="User avatar">
          <img id="profilePic" class="rp-avatar-circle" src="https://placehold.co/120" alt="Profile picture">
          <div id="tierMedal" class="rp-overlay-badge"></div>
          <span id="tierDot" class="rp-tier-dot" aria-hidden="true">
            <i class="fa-solid fa-star"></i>
          </span>
        </div>

        <div class="rp-mini-stack" id="leftMiniStack">
          <span id="miniStreak" class="mini-chip d-none">üî• 0 ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î</span>
          <span id="miniRank"   class="mini-chip d-none">üèÜ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‚Äî</span>
        </div>
      </div>

      <div class="rp-title">
        <h1 id="username" class="rp-username">‚Äî</h1>
        <span id="tierPill" class="rp-tier-pill rp-tier-silver">
          <i class="fa-solid fa-medal me-1"></i><span id="tierName">Silver</span>
        </span>
      </div>
    </div>

    <!-- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏° -->
    <div class="rp-score-stack mt-2">
      <div class="rp-score-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</div>
      <div class="rp-point-value">
        <span id="points">0</span><span class="rp-point-unit"> pt</span>
      </div>
    </div>

    <!-- Progress -->
    <div class="rp-progress-area mt-2">
      <div id="progressBar" class="rp-progress-line prog-silver">
        <div id="progressFill" class="rp-progress-fill"></div>
      </div>
      <div class="text-center small rp-xp-pair">
        <span id="xpPair">0 / 0 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
      </div>
    </div>

    <div class="rp-status-center mt-1">
      <span id="tierStatus" class="status-chip hidden"></span>
    </div>
  </section>

  <!-- Actions -->
  <section id="rpActions" class="rp-actions-wide d-grid gap-2 mb-3">
    <button id="primaryAction" class="btn rp-primary act-btn tap-20" data-bs-toggle="modal" data-bs-target="#scoreModal">
      <i class="fa-solid fa-qrcode me-2"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    </button>
    <button id="historyBtn" class="btn btn-outline-secondary act-btn tap-20">
      <i class="fa-regular fa-clock me-2"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
    </button>
  </section>

  <!-- Ads -->
  <section class="rp-glass rp-card p-0 mb-3 hover-lift">
    <div id="adsCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3500">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#adsCarousel" data-bs-slide-to="0" class="active" aria-current="true"></button>
        <button type="button" data-bs-target="#adsCarousel" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#adsCarousel" data-bs-slide-to="2"></button>
      </div>
      <div class="carousel-inner">
        <div class="carousel-item active">
          <a href="https://example.com/ad1" target="_blank" rel="noopener">
            <img class="d-block w-100" src="https://lh3.googleusercontent.com/d/1MLTZG-32BqdyT4EpFBcSw1fUcdMNX2jJ" alt="ad1">
          </a>
        </div>
        <div class="carousel-item">
          <a href="https://example.com/ad2" target="_blank" rel="noopener">
            <img class="d-block w-100" src="https://lh3.googleusercontent.com/d/1hXJjpdG3gM-Aa25Sn4Rs3bM9j7Ugq51J" alt="ad2">
          </a>
        </div>
        <div class="carousel-item">
          <a href="https://example.com/ad3" target="_blank" rel="noopener">
            <img class="d-block w-100" src="https://lh3.googleusercontent.com/d/1hP8oOd6uk4JQitCktviVZ-QDM75SqPSA" alt="ad3">
          </a>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#adsCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#adsCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span>
      </button>
    </div>
  </section>

  <!-- Skeleton (rewards) -->
  <section class="rp-glass rp-card p-3 p-sm-4 hover-lift">
    <h5 class="mb-2">‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h5>
    <div class="text-end mb-2">
      <a href="/rewards-all.html" class="btn btn-outline-success btn-sm">
        ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </a>
    </div>
    <div id="rewardsSection" class="skeleton-hide-when-loading">
      <div id="rewardRail" class="rp-reward-rail"></div>
    </div>
    <div class="card my-2 reward-skeleton">
      <div class="card-body d-flex gap-3">
        <div class="skeleton skel-thumb"></div>
        <div class="flex-grow-1">
          <div class="skeleton skel-16" style="width:60%"></div>
          <div class="skeleton skel-line" style="width:90%"></div>
          <div class="skeleton skel-line" style="width:70%"></div>
        </div>
      </div>
    </div>
    <div class="card my-2 reward-skeleton">
      <div class="card-body d-flex gap-3">
        <div class="skeleton skel-thumb"></div>
        <div class="flex-grow-1">
          <div class="skeleton skel-16" style="width:50%"></div>
          <div class="skeleton skel-line" style="width:80%"></div>
          <div class="skeleton skel-line" style="width:65%"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Admin FAB -->
<a id="btnAdmin" href="/admin.html" class="btn admin-entry d-none" aria-label="Admin">
  <i class="fa-solid fa-shield-halved"></i>
</a>

<!-- ===== Modals ===== -->
<div class="modal fade" id="scoreModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°</h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
      </div>
      <div class="modal-body text-center">
        <div class="d-flex justify-content-center gap-2 mb-2">
          <button id="startScanBtn" class="btn btn-success btn-sm tap-20">
            <i class="fa-solid fa-camera"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
          </button>
          <button id="stopScanBtn" class="btn btn-outline-danger btn-sm tap-20">
            <i class="fa-solid fa-stop"></i> ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
          </button>
          <button id="torchBtn" class="btn btn-outline-warning btn-sm btn-torch tap-20" disabled>
            <i class="fa-solid fa-bolt"></i> ‡πÑ‡∏ü‡∏â‡∏≤‡∏¢
          </button>
        </div>
        <div id="qr-reader" style="width:100%;max-width:420px;margin:auto;"></div>
        <hr class="my-4" />
        <div class="form-group" style="max-width:420px;margin:auto;">
          <input type="text" id="secretCode" class="form-control" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö" />
          <button id="submitCodeBtn" class="btn btn-primary w-100 mt-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏û‡πâ‡∏≠‡∏¢‡∏ó‡πå</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div id="historyListWrap" class="modal-body pt-0 skeleton-hide-when-loading">
        <div id="historyList" class="list-group list-group-flush"></div>
      </div>

      <div class="modal-body history-skeleton pt-0">
        <div class="skeleton skel-line" style="width:80%"></div>
        <div class="skeleton skel-line" style="width:60%"></div>
        <div class="skeleton skel-line" style="width:70%"></div>
        <div class="skeleton skel-line" style="width:50%"></div>
      </div>

      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- Avatar Preview Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-black">
      <button class="btn btn-light position-absolute end-0 m-2" data-bs-dismiss="modal" aria-label="Close">‚úï</button>
      <img id="avatarPreviewImg" alt="Full profile" class="w-100 h-auto rounded-3">
    </div>
  </div>
</div>

<!-- Mini CTA -->
<div id="miniCta" class="mini-cta d-none" aria-live="polite">
  <button class="btn btn-success btn-sm tap-20" data-bs-toggle="modal" data-bs-target="#scoreModal">
    <i class="fa-solid fa-qrcode"></i> ‡∏™‡πÅ‡∏Å‡∏ô
  </button>
  <button id="miniRefresh" class="btn btn-outline-secondary btn-sm btn-icon tap-20" aria-label="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä">
    <i class="fa-solid fa-rotate"></i>
  </button>
</div>

<!-- ===== App Overlay (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö Loading.apiFetch) ===== -->
<div id="appOverlay" class="app-overlay" role="alert" aria-live="assertive" aria-busy="true">
  <div class="app-overlay__box">
    <div id="overlayMsg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
  </div>
</div>
<style>
  .app-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:2000; background:rgba(0,0,0,.45) }
  .app-overlay.active{ display:flex }
  .app-overlay__box{ background:#111827; color:#fff; padding:.8rem 1rem; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35) }
</style>

<!-- ===== Register Modal (REPLACE THIS WHOLE BLOCK) ===== -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="registerForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-regular fa-id-badge me-2"></i>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
      </div>

      <div class="modal-body">
        <p class="text-muted small mb-3">
          ‡∏û‡∏ö‡∏ß‡πà‡∏≤ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        </p>

        <!-- ‡πÄ‡∏Å‡πá‡∏ö UID ‡∏à‡∏≤‡∏Å LIFF -->
        <input type="hidden" id="regUid" name="uid" />

        <!-- ‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• -->
        <div class="mb-3">
          <label for="regName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" class="form-control" id="regName" name="name" required />
        </div>

        <!-- Section -->
        <div class="mb-3">
          <label for="regRoom" class="form-label">Section</label>
          <select class="form-control" id="regRoom" name="room" required>
            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
            <option value="ACC">ACC</option>
            <option value="C&amp;FA">C&amp;FA</option>
            <option value="CS">CS</option>
            <option value="CIC">CIC</option>
            <option value="DIR">DIR</option>
            <option value="ENG">ENG</option>
            <option value="FIN">FIN</option>
            <option value="GR">GR</option>
            <option value="HP">HP</option>
            <option value="HCM">HCM</option>
            <option value="HRD">HRD</option>
            <option value="HRM">HRM</option>
            <option value="IT">IT</option>
            <option value="L&amp;S">L&amp;S</option>
            <option value="MTN">MTN</option>
            <option value="MKT">MKT</option>
            <option value="MC">MC</option>
            <option value="OS">OS</option>
            <option value="PD">PD</option>
            <option value="PD1">PD1</option>
            <option value="PD2">PD2</option>
            <option value="PC">PC</option>
            <option value="PE">PE</option>
            <option value="PUR">PUR</option>
            <option value="QA">QA</option>
            <option value="QC">QC</option>
            <option value="RDPP">RDPP</option>
            <option value="R&amp;D">R&amp;D</option>
            <option value="SHE">SHE</option>
            <option value="SCM">SCM</option>
            <option value="SYS-ENG">SYS-ENG</option>
            <option value="TSH CENTER">TSH CENTER</option>
            <option value="WH">WH</option>
          </select>
        </div>

        <!-- ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î -->
        <div class="mb-3">
          <label for="regDob" class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
          <input type="date" class="form-control" id="regDob" name="dob" required />
        </div>

        <!-- ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/Passport -->
        <div class="mb-3">
          <label for="regPassport" class="form-label">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/Passport</label>
          <input type="text" class="form-control" id="regPassport" name="passport" required />
        </div>

        <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå -->
        <div class="mb-3">
          <label for="regTel" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
          <input type="tel" class="form-control" id="regTel" name="tel" required inputmode="tel" placeholder="0xxxxxxxxx" />
        </div>
      </div>

      <div class="modal-footer">
        <button type="submit" id="btnRegister" class="btn btn-primary btn-lg w-100">
          ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ===== JS: Bootstrap bundle ===== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ===== Core app scripts ===== -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="/loader.js"></script>
<!-- index.html (‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô <script src="/app.js">) -->
<script>window.__SKIP_AUTO_INIT__ = true;</script>
<script src="/app.js" defer></script>

<!-- ===== Auto-register flow (single gate) ===== -->
<script>
(function () {
  // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏±‡∏ô app.js ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ auto-init ‡∏ã‡πâ‡∏≥
  window.__SKIP_AUTO_INIT__ = true;

  const LIFF_ID  = "2007053300-QoEvbXyn";
  const GET_SCORE = (uid) => `/api/get-score?uid=${encodeURIComponent(uid)}`;
  const REG_URL   = "/api/register";

  const apiFetch = (input, init, opts) =>
    (window.Loading?.apiFetch
      ? window.Loading.apiFetch(input, init, opts || { scope: "page" })
      : fetch(input, init).then((r) => r.json()));

  document.addEventListener("DOMContentLoaded", boot);

  async function boot() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      const prof = await liff.getProfile();
      const uid  = prof.userId;
      window.__UID = uid;

      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÇ‡∏î‡∏¢‡∏î‡∏π status 404 ‡∏ï‡∏£‡∏á‡πÜ
      let needRegister = false;
      try {
        const resp = await fetch(GET_SCORE(uid), { method: "GET" });
        if (resp.status === 404) {
          needRegister = true;
        } else if (!resp.ok) {
          throw new Error("get-score failed with status " + resp.status);
        } else {
          // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πà‡∏≤ ‚Üí ‡∏ö‡∏π‡∏ï‡πÅ‡∏≠‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢
          if (typeof initApp === "function") initApp({ profile: prof, uid, force: true });
        }
      } catch (err) {
        console.warn("Direct fetch get-score error:", err);
      }

      // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° + ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πÄ‡∏Å‡πÄ‡∏•‡∏ï‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á
      if (needRegister) {
        hideSkeletons();
        window.showRegisterModal(prof);
      }
    } catch (err) {
      console.error(err);
      window.Swal
        ? Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö LIFF ‡πÑ‡∏î‡πâ", "error")
        : alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö LIFF ‡πÑ‡∏î‡πâ");
    }
  }

  function hideSkeletons() {
    document.querySelectorAll(".skeleton-hide-when-loading").forEach(el => el.classList.add("d-none"));
    document.querySelectorAll(".reward-skeleton, .history-skeleton").forEach(el => el.classList.add("d-none"));
  }

  // ‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö window ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢
  window.showRegisterModal = function (profile) {
    document.getElementById("regUid").value  = window.__UID || "";
    document.getElementById("regName").value = profile?.displayName || "";

    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById("registerModal"));
    modal.show();

    const form = document.getElementById("registerForm");
    if (!form.dataset.bound) {
      form.dataset.bound = "1";
      form.addEventListener("submit", onSubmitRegister);
    }
  };

  async function onSubmitRegister(ev) {
    ev.preventDefault();
    const payload = {
      uid:  document.getElementById("regUid").value.trim(),
      name: document.getElementById("regName").value.trim(),
      room: document.getElementById("regRoom").value.trim(),
      dob:  document.getElementById("regDob").value.trim(),
      passport: document.getElementById("regPassport").value.trim(),
      tel:  document.getElementById("regTel").value.trim(),
    };

    if (!payload.uid || !payload.name) {
      return (window.Swal
        ? Swal.fire("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", "warning")
        : alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"));
    }

    try {
      await apiFetch(REG_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }, { scope: "overlay", msg: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô..." });

      // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
      window.Swal ? Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","success") : alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
      bootstrap.Modal.getInstance(document.getElementById('registerModal'))?.hide();

      // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• + ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
      await hydrateAfterRegister(payload.uid);

      // ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ‡∏ö‡∏π‡∏ï‡πÅ‡∏≠‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (force = true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
      if (typeof initApp === "function") initApp({ uid: payload.uid, force: true });
    } catch (err) {
      console.error(err);
      window.Swal ? Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error") : alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  }
})();
</script>

</body>
</html>
